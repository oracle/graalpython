name: Test on exotic platforms
on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  centos-ppc64le-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build maven artifacts
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake build-essential python3 maven
          git clone --depth=1 https://github.com/graalvm/mx.git
          export PATH=$PWD/mx:$PATH
          export NATIVE_IMAGES=''
          mx sforceimport
          mx -p ../graal/vm fetch-jdk -A --jdk-id labsjdk-ce-latest
          export JAVA_HOME="$HOME/.mx/jdks/labsjdk-ce-latest/"
          mx deploy-local-maven-repo
          mv mxbuild/jdk*/mx.graalpython/public-maven-repo m2repo

      - name: Install OpenJ9 17
        uses: actions/setup-java@v5
        with:
          distribution: 'semeru'
          java-version: '17'
      - name: Test on OpenJ9 17
        run: |
          echo "Using $JAVA_HOME"
          $JAVA_HOME/bin/java -version
          mkdir $(pwd)/user_resource_cache
          mvn -f graalpython/com.oracle.graal.python.test.integration/pom.xml -Dcom.oracle.graal.python.test.polyglot.version=26.0.0 -Dcom.oracle.graal.python.test.polyglot_repo=file:///$(pwd)/m2repo --batch-mode -U -Dtruffle.UseFallbackRuntime=true -Dpolyglot.engine.allowUnsupportedPlatform=true -Dpolyglot.engine.userResourceCache=/$(pwd)/user_resource_cache -Dpolyglot.python.UnsupportedPlatformEmulates=linux -Dorg.graalvm.python.resources.exclude=native.files test -Dtest=HelloWorldTests,AttributeTests,BuiltinSubclassTest,ComplexTexts,CreateClassTest,AsyncActionThreadingTest,JavaInteropTest
          rm -rf $(pwd)/user_resource_cache

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: ppc64le

      - uses: docker/setup-docker-action@v4

      - name: Test on ppc64le using Docker
        run: |
          docker run --rm --platform=linux/ppc64le -v "${GITHUB_WORKSPACE}:/workspace" -w /workspace ubuntu:24.04 bash -c "
            apt-get update
            apt-get install -y python3 git wget tar gzip cmake build-essential maven openjdk-17-jdk
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-ppc64el
            export PATH=\$JAVA_HOME/bin:\$PATH

            echo 'Using \$JAVA_HOME'
            \$JAVA_HOME/bin/java -version
            mkdir \$(pwd)/user_resource_cache
            mvn -f graalpython/com.oracle.graal.python.test.integration/pom.xml -Dcom.oracle.graal.python.test.polyglot.version=26.0.0 -Dcom.oracle.graal.python.test.polyglot_repo=file:///\$(pwd)/m2repo --batch-mode -U -Dtruffle.UseFallbackRuntime=true -Dpolyglot.engine.allowUnsupportedPlatform=true -Dpolyglot.engine.userResourceCache=/\$(pwd)/user_resource_cache -Dpolyglot.python.UnsupportedPlatformEmulates=linux -Dorg.graalvm.python.resources.exclude=native.files test -Dtest=HelloWorldTests,AttributeTests,BuiltinSubclassTest,ComplexTexts,CreateClassTest,AsyncActionThreadingTest,JavaInteropTest
            rm -rf \$(pwd)/user_resource_cache
          "
